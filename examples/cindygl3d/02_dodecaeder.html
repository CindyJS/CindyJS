<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Cindy JS</title>
        <script type="text/javascript" src="../../build/js/Cindy.js"></script>
        <script type="text/javascript" src="../../build/js/CindyGL3D.js"></script>
        <link rel="stylesheet" href="../../css/cindy.css" />
    </head>

    <body style="font-family: Arial">
        <h1>CindyGL3D: multiple spheres</h1>

        <script id="csdraw" type="text/x-cindyscript">
            time = seconds()-t0;
            alpha = .5+mouse().x;

            rho = re(time/5+mouse().y);
            theta = re(mouse().x+time/10);

            r=.7;
            cglReset3d();
            cglResetRotation();
            rotate3d(theta,rho);
            // TODO find/create a way to pass fixed value to colorplot (allows to call plot in loop)
            colorplot3d(sphere(#,cglViewPos,vertices_1,r),vertices_1,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_2,r),vertices_2,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_3,r),vertices_3,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_4,r),vertices_4,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_5,r),vertices_5,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_6,r),vertices_6,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_7,r),vertices_7,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_8,r),vertices_8,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_9,r),vertices_9,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_10,r),vertices_10,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_11,r),vertices_11,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_12,r),vertices_12,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_13,r),vertices_13,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_14,r),vertices_14,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_15,r),vertices_15,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_16,r),vertices_16,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_17,r),vertices_17,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_18,r),vertices_18,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_19,r),vertices_19,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_20,r),vertices_20,r*1.05);
            cglDraw3d();
        </script>
        <!--
            colorplot3d(sphere(#,cglViewPos,vertices_1,r));
            colorplot3d(sphere(#,cglViewPos,vertices_2,r));
            colorplot3d(sphere(#,cglViewPos,vertices_3,r));
            colorplot3d(sphere(#,cglViewPos,vertices_4,r));
            colorplot3d(sphere(#,cglViewPos,vertices_5,r));
            colorplot3d(sphere(#,cglViewPos,vertices_6,r));
            colorplot3d(sphere(#,cglViewPos,vertices_7,r));
            colorplot3d(sphere(#,cglViewPos,vertices_8,r));
            colorplot3d(sphere(#,cglViewPos,vertices_9,r));
            colorplot3d(sphere(#,cglViewPos,vertices_10,r));
            colorplot3d(sphere(#,cglViewPos,vertices_11,r));
            colorplot3d(sphere(#,cglViewPos,vertices_12,r));
            colorplot3d(sphere(#,cglViewPos,vertices_13,r));
            colorplot3d(sphere(#,cglViewPos,vertices_14,r));
            colorplot3d(sphere(#,cglViewPos,vertices_15,r));
            colorplot3d(sphere(#,cglViewPos,vertices_16,r));
            colorplot3d(sphere(#,cglViewPos,vertices_17,r));
            colorplot3d(sphere(#,cglViewPos,vertices_18,r));
            colorplot3d(sphere(#,cglViewPos,vertices_19,r));
            colorplot3d(sphere(#,cglViewPos,vertices_20,r));

            colorplot3d(sphere(#,cglViewPos,vertices_1,r),vertices_1,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_2,r),vertices_2,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_3,r),vertices_3,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_4,r),vertices_4,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_5,r),vertices_5,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_6,r),vertices_6,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_7,r),vertices_7,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_8,r),vertices_8,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_9,r),vertices_9,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_10,r),vertices_10,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_11,r),vertices_11,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_12,r),vertices_12,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_13,r),vertices_13,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_14,r),vertices_14,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_15,r),vertices_15,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_16,r),vertices_16,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_17,r),vertices_17,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_18,r),vertices_18,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_19,r),vertices_19,r*1.05);
            colorplot3d(sphere(#,cglViewPos,vertices_20,r),vertices_20,r*1.05);
        -->

        <script id="csinit" type="text/x-cindyscript">
            use("CindyGL3D");
            oo = 1000; //"infinity"
            t0 = seconds();

            phi=(1+sqrt(5))/2;
            vertices=[
              [1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1],
              [0,phi,1/phi],[0,phi,-1/phi],[0,-phi,1/phi],[0,-phi,-1/phi],
              [1/phi,0,phi],[1/phi,0,-phi],[-1/phi,0,phi],[-1/phi,0,-phi],
              [phi,1/phi,0],[phi,-1/phi,0],[-phi,1/phi,0],[-phi,-1/phi,0]
            ];

            ray(direction,viewPos, t) := (
              t*direction+viewPos
            );

            A = apply(0..2,c,apply(0..2,i,(5*c)^i));
            // A sends polynomials [p0, p1, p2] = p0+p1*X+p2*X*Xto [p(0), p(5), p(10)]
            B = inverse(A); //B interpolates polynomials, given the values [p(0), p(5), p(10))]

            addlight(oldcolor, lightcolor, lightdir, normal, gamma) := (
              illumination = max(0,(lightdir/abs(lightdir))*normal);
              oldcolor + (illumination^gamma)*lightcolor
            );

            S(p,M,r) := ( (p-M)*(p-M) - r*r );
            sphere(direction,viewPos,M,r) := (
              spolyvalues = [S(ray(direction,viewPos, 0),M,r), S(ray(direction,viewPos, 5),M,r), S(ray(direction,viewPos, 10),M,r)];
              spoly = B*spolyvalues; // interpolate
              D = (spoly_2*spoly_2)-4.*spoly_3*spoly_1; //discriminant of spoly
              if(D<0, //ray intersects ball
                [0,0,0,0],
                lambda=(-spoly_2-re(sqrt(D)))/(2.*spoly_3);
                spacePos = ray(direction,viewPos, lambda);
                dst=|spacePos-viewPos|;//XXX? sign
                n = spacePos-M;
                n = n/abs(n);
                lightdir0 = viewPos-spacePos;
                mouse2d=mouse();
                mouselightpos = ray((mouse2d_1,mouse2d_2,.5),viewPos, 7);
                lightdir2 = mouselightpos-spacePos;
                lightdir3 = ray((.0,.0,1.),viewPos,-100.);
                color0 = .6*(1., .6,.3);
                color1 = min(2.,1/(lightdir2*lightdir2))*(1.,.3,.3); //glowing mouse
                color2 = min(2.,1/(lightdir2*lightdir2))*(.6,.4,2.); //glowing mouse
                color3 = (.1,.3,.8);
                color4 = (.9,.3,.0);
                rgb=addlight(addlight(addlight(addlight(
                (0,0,0),
                  color0, lightdir0, n, 2),
                  color1, lightdir2, -n, 1),
                  color2, lightdir2, n, 1),
                  color3, lightdir3, n, 2);
                cglDepth = dst/16;
                [rgb_1,rgb_2,rgb_3,1]
              )
            );
            cglBegin3d();
        </script>

        <div id="CSCanvas" style="border: 0px"></div>

        <script type="text/javascript">
            CindyJS({
                canvasname: "CSCanvas",
                scripts: "cs*",
                animation: { autoplay: true },
                ports: [
                    {
                        id: "CSCanvas",
                        width: 500,
                        height: 500,
                        transform: [{ visibleRect: [-4, -4, 4, 4] }],
                    },
                ],
            });
        </script>
        drawing multiple 3D objects into the same canvas
    </body>
</html>

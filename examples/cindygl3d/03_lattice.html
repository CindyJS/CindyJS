<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Cindy JS</title>
        <script type="text/javascript" src="../../build/js/Cindy.js"></script>
        <script type="text/javascript" src="../../build/js/CindyGL3D.js"></script>
        <link rel="stylesheet" href="../../css/cindy.css" />
    </head>

    <body style="font-family: Arial">
        <h1>CindyGL3D: lattice</h1>

        <script id="csdraw" type="text/x-cindyscript">
            time = seconds()-t0;
            alpha = .5+mouse().x;

            rho = re(time/5+mouse().y);
            theta = re(mouse().x+time/10);

            N=20;
            r=1/N;
            colorplotbegin3d();
            rotate3d(theta,rho);
            // TODO unlink unlike program and renderer
            //   the same compiled program can be rendered in multiple different ways
            //   a) split renderer and program, renderer -> program+boundingBox+fixedVariables
            //   b) move bounding box to render call, renderer -> collection of shader scripts attached to program
            // TODO find/create a way to pass fixed value to colorplot (allows to call plot in loop)
            f(pos,viewPos):=([|pos-viewPos|*0.05,0,1,0,0.5]);
            forall(0..N,x,forall(0..N,y,forall(0..N,z,
              colorplot3d(f(#,cglViewPos),[2*x/N-1,2*y/N-1,2*z/N-1],r*1.05);
            )));
            colorplotend3d();
        </script>

        <script id="csinit" type="text/x-cindyscript">
                  use("CindyGL3D");
                  oo = 1000; //"infinity"
                  t0 = seconds();

                  ray(pos3d,viewPos, t) := (
                    t*(pos3d-viewPos)+viewPos
                  );

                  A = apply(0..2,c,apply(0..2,i,(5*c)^i));
                  // A sends polynomials [p0, p1, p2] = p0+p1*X+p2*X*Xto [p(0), p(5), p(10)]
                  B = inverse(A); //B interpolates polynomials, given the values [p(0), p(5), p(10))]

                  addlight(oldcolor, lightcolor, lightdir, normal, gamma) := (
                    illumination = max(0,(lightdir/abs(lightdir))*normal);
                    oldcolor + (illumination^gamma)*lightcolor
                  );

                  S(p,M,r) := ( (p-M)*(p-M) - r*r );
                  sphere(pos,viewPos,M,r) := (
                    spolyvalues = [S(ray(pos,viewPos, 0),M,r), S(ray(pos,viewPos, 5),M,r), S(ray(pos,viewPos, 10),M,r)];
                    spoly = B*spolyvalues; // interpolate
                    D = (spoly_2*spoly_2)-4.*spoly_3*spoly_1; //discriminant of spoly
                    // TODO? draw back face (if transparent)
                    if(D<0, //ray intersects ball
                      [1,0,1,0,0.5],
                      lambda=(-spoly_2-re(sqrt(D)))/(2.*spoly_3);
                      spacePos = ray(pos,viewPos, lambda);
                      dst=|spacePos-viewPos|;//XXX? sign
                      n = spacePos-M;
                      n = n/abs(n);
                      lightdir0 = viewPos-spacePos;
                      mouse2d=mouse();
                      mouselightpos = ray((mouse2d_1,mouse2d_2,.5),viewPos, 7);
                      lightdir2 = mouselightpos-spacePos;
                      lightdir3 = ray((.0,.0,1.),viewPos,-100.);
                      color0 = .6*(1., .6,.3);
                      color1 = min(2.,1/(lightdir2*lightdir2))*(1.,.3,.3); //glowing mouse
                      color2 = min(2.,1/(lightdir2*lightdir2))*(.6,.4,2.); //glowing mouse
                      color3 = (.1,.3,.8);
                      color4 = (.9,.3,.0);
                      rgb=addlight(addlight(addlight(addlight(
                      (0,0,0),
                        color0, lightdir0, n, 2),
                        color1, lightdir2, -n, 1),
                        color2, lightdir2, n, 1),
                        color3, lightdir3, n, 2);
                      [dst/16,rgb_1,rgb_2,rgb_3,1]
                    )
                  );
        </script>

        <div id="CSCanvas" style="border: 0px"></div>

        <script type="text/javascript">
            CindyJS({
                canvasname: "CSCanvas",
                scripts: "cs*",
                animation: { autoplay: true },
                ports: [
                    {
                        id: "CSCanvas",
                        width: 500,
                        height: 500,
                        transform: [{ visibleRect: [-2, -2, 2, 2] }],
                    },
                ],
            });
        </script>
    </body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    
    <title>Konstruktion.cdy</title>
    <style type="text/css">
.mode-selector input{
    margin:0;padding:0px;
    -webkit-appearance:none;
       -moz-appearance:none;
            appearance:none;
}




.mode-selector-2 input:active +.mode, .mode-selector input:active +.mode{
    opacity: .4;
     background-color:rgba(255,0,0,.7);
}
.mode-selector-2 input:checked +.mode, .mode-selector input:checked +.mode{
    -webkit-filter: none;
       -moz-filter: none;
            filter: none;
     background-color:rgba(150,150,150,.7);



}
.mode{
    cursor:pointer;
    background-size:contain;
    background-repeat:no-repeat;
    background-color:rgba(255,255,255,.6);
    margin: 1px;

    display:inline-block;
    width:48px;height:36px;
    -webkit-transition: all 100ms ease-in;
       -moz-transition: all 100ms ease-in;
            transition: all 100ms ease-in;


}

.mode-selector {
  background: rgba(0,0,0,.3);
  z-index: 100;
  position: absolute;
  top: 20px;
  left: 20px;
  padding: 5px;
  border-radius: 5px;
  
  display: flex;
  flex-direction: column;
}

body{
  padding: 0;
  margin: 0;
}

#CSCanvas {
  width: 100vw;
  height: 100vh;
}

#console {
  border: none !important;
  font-family: monospace;
}

#cmd {
  background-color: rgba(255,255,255,.3);
  border: 0;
}
    </style>
    <script type="text/javascript" src="../../build/js/Cindy.js"></script>


               
    <script id="csinit" type="text/x-cindyscript">

        //======CODE FOR BUTTONS==========
 
        setmode(m):=(
           apply(allelements(),#.pinned=true);
           mode=m;
           print(mode);
        );
        ////////

    ptcnt=0;
    lncnt=0;
    cncnt=0;

    inaction=false;
    selpts=[];
    sellns=[];
    selcns=[];
    tmppts=[];
    tmplns=[];
    tmpcns=[];

    iscircle(c):=contains(circs,c);

    ishotp(pos,p):=|pos,p|<.5;

    ishotl(pos,l):=(
       regional(p);
       p=meet(l,perp(l,pos));
       |p.xy,pos|<.4;
    );
    
    ishotc(p,c):=(
       regional(mat,p1,p2,p3,p4,s1,s2,s3,s4);
       mat=c.matrix;
       p1=(p+(.4,0)).homog;
       p2=(p-(.4,0)).homog;
       p3=(p+(0,.4)).homog;
       p4=(p-(0,.4)).homog;
       s1=if(p1*mat*p1>0,1,-1);
       s2=if(p2*mat*p2>0,1,-1);
       s3=if(p3*mat*p3>0,1,-1);
       s4=if(p4*mat*p4>0,1,-1);

       set([s1,s2,s3,s4])==[-1,1];
    );
 
    
    elementsAtPos(pos):=(
      regional(spts,slns,scns);
      nearpts=select(pts,ishotp(pos,#));
      nearlns=select(lns,ishotl(pos,#));
      nearcns=select(cns,ishotc(pos,#));

      spts=nearpts;
      slns=[];
      scns=[];

      slns=if(spts==[],nearlns,[]);
      scns=if(spts==[],nearcns,[]);
      (spts,slns,scns);

    );

    resetsels():=(
      selpts=[];
      sellns=[];
      selcns=[];
    );

    //======GENERIC TRAP FOR  MOUSE EVENTS==========

    dodown():=( 
           pos=mouse().xy;
           inaction=true;
           parse(mode+"Down(pos)");

    );

    dodrag():=(
     if(inaction,
        pos=mouse().xy;
        parse(mode+"Drag(pos)");
       );
    );

    doup():=(
      if(inaction,
        pos=mouse().xy;
        parse(mode+"Up(pos)");

     );
     apply(allelements(),#.pinned=true);

    );

adjoint(m):=(
    (
      det(((m_2_2,m_2_3),(m_3_2,m_3_3))),
     -det(((m_2_1,m_2_3),(m_3_1,m_3_3))),
      det(((m_2_1,m_2_2),(m_3_1,m_3_2)))
    ),
    (
     -det(((m_1_2,m_1_3),(m_3_2,m_3_3))),
      det(((m_1_1,m_1_3),(m_3_1,m_3_3))),
     -det(((m_1_1,m_1_2),(m_3_1,m_3_2)))
    ),
    (
      det(((m_1_2,m_1_3),(m_2_2,m_2_3))),
     -det(((m_1_1,m_1_3),(m_2_1,m_2_3))),
      det(((m_1_1,m_1_2),(m_2_1,m_2_2)))
    )
);
crossop(l):=((0,l_3,-l_2),
             (-l_3,0,l_1),
             (l_2,-l_1,0));

intersectcc(c1,c2):=(
    cc=c1++c2;
    d3=det(cc_[1,2,3]);
    d2=det(cc_[1,2,6])+det(cc_[1,5,3])+det(cc_[4,2,3]);
    d1=det(cc_[4,5,3])+det(cc_[4,2,6])+det(cc_[1,5,6]);
    d0=det(cc_[4,5,6]);
    //TODO Degenerierte Fälle abfangen
    sols=roots([d0,d1,d2,d3]);
    sol1=sols_1;
    sol2=sols_2;
    deg1=c1*sol1+c2;
    deg2=c1*sol2+c2;

    ad1=adjoint(deg1);
    ad2=adjoint(deg2);
    p1=ad1_1/sqrt(-ad1_1_1);
    p2=ad2_1/sqrt(-ad2_1_1);

    mm1=crossop(p1);
    mm2=crossop(p2);
    sp1=mm1+deg1;
    sp2=mm2+deg2;

    l1=sp1_1;
    l2=transpose(sp1)_1;
    l3=sp2_1;
    l4=transpose(sp2)_1;

    [meet(l1,l3),meet(l2,l3),meet(l1,l4),meet(l2,l4)];
);


intersectcircir(c1,c2):=(
   ln=c2_1_1*c1_3-c1_1_1*c2_3;
   ln=(ln_1,ln_2,.5*ln_3);
   intersectcl(c1,ln);
);



intersectcl(c,l):=(

    l1 = crossop(l);
    l2=transpose(l1);
    s=l2*c*l1;
    maxidx=sort(1..3,-|l_#|)_1;
    idx=(1..3)--[maxidx];
    a11 = s_(idx_1)_(idx_1);
    a12 = s_(idx_1)_(idx_2);
    a21 = s_(idx_2)_(idx_1);
    a22 = s_(idx_2)_(idx_2);
    b = l_maxidx;
    alp=sqrt(-det(((a11,a12),(a21,a22))))/b;
    erg=s+alp*l1;
    //TODO select col row
    erg1=point(erg_1);
    erg2=point(transpose(erg)_1);
    [erg1.xy, erg2.xy];
);

closest(list,pt):=(
   sort(list,|#.xy,pt.xy|)_1;
);

projecttocircle(c,pt):=(

   mid=(inverse(c)*(0,0,1)).xy;
   cc=c/c_1_1;//TODO: Das ist jetzt grad recht euklidisch gerechnet
   r=sqrt((cc_1_3)^2+(cc_2_3)^2-cc_3_3);
   vec=(pt.xy-mid);
   mid+r*(vec/|vec|);
);

circlepp(mid,pt):=(
  mm=mid.xy;
  pp=pt.homog;
  mat1=((1,0,-mm.x),(0,1,-mm.y),(-mm.x,-mm.y,mm.x^2+mm.y^2));
  mat2=((0,0,0),(0,0,0),(0,0,1));
  mat1*(pp*mat2*pp)-mat2*(pp*mat1*pp) 
);

circlepr(mid,r):=(
   circlepp(mid,mid.xy+(0,r)); 
);

//======THE MODI ==========

toggleset(a,b):=(a--b)++(b--a);


//=======  MOVE  ==============
    moveDown(pos):=(
        apply(allelements(),#.pinned=false);    
        movedown=true;
        perhapsclick=true;
        movedownpos=mouse().xy;   
    );

    moveUp(pos):=(
       if(|movedownpos,mouse().xy|>.1,perhapsclick=false);
       if(perhapsclick,
            (spts,slns,scns)=elementsAtPos(pos);
            if((spts,slns,scns)==([],[],[]),
              (selpts,sellns,selcns)=([],[],[]);
            ,
              selpts=toggleset(selpts,spts);
              sellns=toggleset(sellns,slns);
              selcns=toggleset(selcns,scns);
            );

       );
    );

    moveDrag(pos):=(
      if(|movedownpos,mouse().xy|>.1,perhapsclick=false);

    );
//==============================


createSinglePoint(pos):=(
      regional(pt,prepare);
         (selpts,sellns,selcns)=elementsAtPos(pos);
         pt=pos;
         prepare="Free";
         params=[];
         if(length(selpts)==1,
            pt=(selpts_1).xy;
            prepare="Old";
            params=[selpts_1]
         );
         if(length(sellns)==1 & length(selcns)==0 ,
           pt=meet(sellns_1,perp(sellns_1,pos)).xy;
           prepare="PointOnLine";
           params=[sellns_1];
         );
         if(length(sellns)==0 & length(selcns)==1 ,
           if(iscircle(selcns_1),
             pt=projecttocircle((selcns_1).matrix,pos);
             prepare="PointOnCircle";
             params=[selcns_1];
           )
         );
         if(length(sellns)>=2 & length(selcns)==0 ,
            pt=meet(sellns_1,sellns_2);
            prepare="Meet";
            params=[sellns_1,sellns_2];

         );
         if(length(sellns)>=1 & length(selcns)==1 ,
           pt=closest(intersectcl((selcns_1).matrix,(sellns_1).homog),pos);
           prepare="IntersectLC";
           params=[sellns_1,selcns_1];

         );
         if(length(sellns)==1 & length(selcns)>=1 ,
           pt=closest(intersectcl((selcns_1).matrix,(sellns_1).homog),pos);
           prepare="IntersectLC";
           params=[sellns_1,selcns_1];

         );
         if(length(sellns)==0 & length(selcns)>=2 ,
           pt=closest(intersectcc((selcns_1).matrix,(selcns_2).matrix),pos);
           prepare="IntersectionConicConic";
           if(iscircle(selcns_1) &iscircle(selcns_2),
              pt=closest(intersectcircir((selcns_1).matrix,(selcns_2).matrix),pos);
              print("PT:"+pt);
              prepare="IntersectionCircleCircle";
           );
           params=[selcns_1,selcns_2];
         );
         [pt,prepare,params]; 

);

myeps=0.000001;

getthatguy(inp,pos):=(
   //TODO if inop is a list, this only works for homog coords.
   if(!islist(inp),
   inp
   ,
   notthere=select(inp,!contains(pts,#));
   match=select(inp,|pos.xy,#.xy|<myeps);//TODO eventuell anderer test (projectiveDistMinScal)
   apply(notthere,
         (#).alpha=0;
        );
   apply(match,
         (#).alpha=1;
        );
   match_1;
   ) 

);


finalizetmps():=(
   regional(P,type);
   newpts=[]; 
   selpts=[];
   sellns=[];
   selcns=[];
   apply(tmppts,tmp,
      if(tmp_4=="final",
         type="plain";
          if(tmp_2=="Old",type="Old");
          if(tmp_2=="Mid",type="Mid");

          if(type=="plain",  
            P = getthatguy(create(tmp_2,tmp_3++[(tmp_1)]),tmp_1);
            selpts=[P];
            newpts=newpts++[P];
         );

    
          if(type=="Mid",
            regional(el);   
            el=create(tmp_2,newpts);
            sellns=[el];
         );

    
         if(type=="Old",
            selpts=[tmp_3_1];
            (tmp_3_1).alpha=1;
            newpts=newpts++[tmp_3_1];
         );

      );

   );

   apply(tmplns,tmp,
         if(tmp_2=="Join";,
            regional(el);   
            el=create(tmp_2,newpts);
            sellns=[el];
         );
   );

   apply(tmpcns,tmp,
        print("TMP:"+tmp);
         if(tmp_2=="CircleMP";,
            regional(el);   
            el=create(tmp_2,newpts);
            sellns=[el];
         );
         if(tmp_2=="CircleMr";,
            regional(el);   
            //el=create(tmp_2,newpts++[radius]);
            el=create(tmp_2,newpts, radius->radius);
            //el.radius = radius;
            selcns=[el];
         );
   );


);
//=========ADD POINT============
    singlepointDown(pos):=(
         (pt,prepare,params)=createSinglePoint(pos);
         tmppts=[[pt,prepare,params,"final"]];
    );


    singlepointDrag(pos):=(
        
         (pt,prepare,params)=createSinglePoint(pos);
         tmppts=[[pt,prepare,params,"final"]];

    );


    singlepointUp(pos):=(
       resetsels();
       finalizetmps();
       tmppts=[];
    );

//==============================


//============ADD LINE==================
    singlelineDown(pos):=(
         (pt,prepare,params)=createSinglePoint(pos);
         first=[pt,prepare,params,"final"];
         tmppts=[first];
    );

    singlelineUp(pos):=(
       resetsels();
       finalizetmps();
       tmppts=[];
       tmplns=[];
    );

    singlelineDrag(pos):=(
        (pt,prepare,params)=createSinglePoint(pos);
         second=[pt,prepare,params,"final"];
         line=meet(first_1,second_1);
         tmppts=[first,second];
         tmplns=[[line,"Join",[first,second],"final"]];

    );
//==============================


//============ADD MID==================
    middleDown(pos):=(
         (pt,prepare,params)=createSinglePoint(pos);
         first=[pt,prepare,params,"final"];
         tmppts=[first];
    );

    middleUp(pos):=(
       resetsels();
       finalizetmps();
       tmppts=[];
    );

    middleDrag(pos):=(
        (pt,prepare,params)=createSinglePoint(pos);
         second=[pt,prepare,params,"final"];
         mid=((first_1).xy+(second_1).xy)/2;
         tmppts=[first,second,[mid,"Mid",[first,second],"final"]];

    );
//==============================



//============ADD CIRCLEPP==================
    circleppDown(pos):=(
         (pt,prepare,params)=createSinglePoint(pos);
         first=[pt,prepare,params,"final"];
         tmppts=[first];
    );

    circleppUp(pos):=(
       resetsels();
       finalizetmps();
       tmppts=[];
       tmpcns=[];
    );

    circleppDrag(pos):=(
        (pt,prepare,params)=createSinglePoint(pos);
         second=[pt,prepare,params,"final"];
         circ=circlepp(first_1,second_1);
         tmppts=[first,second];
         tmpcns=[[circ,"CircleMP",[first,second],"final"]];

    );
//==============================


//============ADD CIRCLEMR==================
    circleprDown(pos):=(
         (pt,prepare,params)=createSinglePoint(pos);
         first=[pt,prepare,params,"final"];
         tmppts=[first];
    );

    circleprUp(pos):=(
       resetsels();
       finalizetmps();
       tmppts=[];
       tmpcns=[];
    );

    circleprDrag(pos):=(
         (pt,prepare,params)=createSinglePoint(pos);
         second=[pt,prepare,params,"final"];
        if(prepare!="Old",
           circ=circlepr(first_1,|pos.xy,(first_1).xy|);
           radius=|pos.xy,(first_1).xy|;
           tmppts=[first];
           tmpcns=[[circ,"CircleMr",[first,radius],"final"]];
        ,
           circ=circlepp(first_1,second_1);
           tmppts=[first,second];
           tmpcns=[[circ,"CircleMP",[first,second],"final"]];

        );


    );
//==============================





    </script>
    

    <script id="csmousedown" type="text/x-cindyscript">
        pos=mouse().xy;
        dodown();
    </script>

    
    <script id="csmousedrag" type="text/x-cindyscript">
        dodrag();
    </script>

    <script id="csmouseup" type="text/x-cindyscript">

        doup();
    </script>






    <script id="csdraw" type="text/x-cindyscript">
data = apply(allelements(),([[#.name],algorithm(#),inputs(#),#.alpha]));
c=0;
forall(data, drawtext((-14,17-c*.5),#_(1..3),size->10,alpha->if(#_4==0,.3,1));c=c+1;);

        pts=allpoints();
        lns=alllines();
        cns=allconics();
        circs=allcircles();
        apply(selpts,draw(#,size->#.size+4,color->(1,1,1),border->false));
        apply(sellns,draw(#.homog,size->#.size+4,color->(1,1,1),border->false));
        apply(selcns,drawconic(#.matrix,size->#.size+4,color->(1,1,1),border->false));
        apply(tmppts,
          draw(#_1,size->5,color->(1,0,0));
          drawtext(#_1+(.2,.2),apply(#_1,q,format(q,2)),size->13,color->(1,1,1)*.4);
        );
        apply(tmplns,
          draw(line(#_1),size->2,color->(0,0,1));
        );
        apply(tmpcns,
          drawconic(#_1,size->2,color->(0,0,1));
        );

    </script>
    



    <script type="text/javascript">

var cdy = CindyJS({
  scripts: "cs*",
  autoplay: true,
  defaultAppearance: {
    dimDependent: 0.7,
    fontFamily: "sans-serif",
    lineSize: 1,
    pointSize: 5.0,
    textsize: 12.0
  },
  angleUnit: "°",
  geometryY: [
    {name: "A", type: "Free", pos: [4.0, -2.6440677966101696, -1.6949152542372883], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "B", type: "Free", pos: [-2.4484848484848487, -4.0, -0.6060606060606061], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "a", type: "Join", color: [0.0, 0.0, 1.0], args: ["A", "B"], labeled: true},
    {name: "C", type: "Free", pos: [-1.4585635359116023, -4.0, -0.5524861878453039], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "D", type: "Free", pos: [4.0, -0.6451612903225806, 3.225806451612903], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "b", type: "Join", color: [0.0, 0.0, 1.0], args: ["C", "D"], labeled: true},
    {name: "E", type: "Free", pos: [-3.3499999999999996, -4.0, -1.2499999999999998], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "C0", type: "CircleByRadius", pos: {xx: -0.0851034858387799, yy: -0.0851034858387799, zz: 0.9999999999999999, xy: 0.0, xz: 0.4561546840958603, yz: -0.5446623093681914}, color: [0.0, 0.0, 1.0], radius: 5.40118505515225, args: ["E"], printname: "$C_{0}$"},


    {name: "F", type: "PointOnCircle", pos: [4.0, {r: 1.5839261089361172, i: -1.401228376110472E-16}, {r: 0.49497690904253633, i: 1.1532127570557923E-32}], color: [1.0, 0.0, 0.0], args: ["C0"], labeled: true},
    {name: "G", type: "Free", pos: [4.0, -2.528, -0.8], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "H", type: "Free", pos: [0.5066666666666667, -4.0, -0.6666666666666666], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "K", type: "Free", pos: [4.0, 3.609756097560976, 0.6097560975609757], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "L", type: "Free", pos: [4.0, -1.2413793103448276, 0.8620689655172413], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "M", type: "Free", pos: [4.0, 0.8231511254019294, 0.3215434083601286], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "C1", type: "ConicBy5", color: [0.0, 0.0, 1.0], args: ["M", "H", "K", "L", "G"], printname: "$C_{1}$"},
    {name: "N", type: "Free", pos: [-2.2784810126582276, -4.0, -0.3164556962025316], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "O", type: "Free", pos: [4.0, 1.3617021276595744, 0.42553191489361697], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "P", type: "Free", pos: [4.0, 1.812332439678284, 0.2680965147453083], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "Poly0", type: "Poly", color: [0.0, 0.0, 0.0], fillcolor: [1.0, 0.784, 0.0], fillalpha: 1.0, args: ["N", "O", "P"]}
  ],
    geometryX: [
    {name: "A", type: "Free", pos: [4.0, 3.189189189189189, -1.3513513513513513], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "B", type: "Free", pos: [-3.2815533980582523, -4.0, -0.4854368932038835], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "a", type: "Join", color: [0.0, 0.0, 1.0], args: ["A", "B"], labeled: true},
    {name: "C", type: "Free", pos: [1.0778443113772456, -4.0, -0.5988023952095808], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "D", type: "Free", pos: [4.0, -0.20634920634920634, 0.3968253968253968], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "b", type: "Join", color: [0.0, 0.0, 1.0], args: ["C", "D"], labeled: true},
    {name: "E", type: "Free", pos: [-0.4186046511627907, -4.0, -1.1627906976744187], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "C0", type: "CircleByRadius", pos: {xx: -0.08387010198604401, yy: -0.08387010198604401, zz: 0.9999999999999999, xy: 0.0, xz: 0.060386473429951695, yz: -0.5770263016639828}, color: [0.0, 0.0, 1.0], radius: 4.887371481686245, args: ["E"], printname: "$C_{0}$"},
    {name: "F", type: "Free", pos: [4.0, 1.8274111675126903, 0.5076142131979695], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "G", type: "Free", pos: [-1.9259259259259258, -4.0, -0.7407407407407407], color: [1.0, 0.0, 0.0], labeled: true},
    {name: "C1", type: "CircleMP", color: [0.0, 0.0, 1.0], args: ["F", "G"], printname: "$C_{1}$"}
  ],
  geometry: [
  ],
  ports: [{
    id: "CSCanvas",
    //width: 900,
    //height: 600,
    transform: [{visibleRect: [-15, 18, 20, -5]}],
    background: "rgb(168,168,192)",
    grid: 1
  }],
      images:{
        "move":"images/move.png",
        "singlepoint":"images/single-add.png",
        "singleline":"images/multi-add-line.png"
    },
  csconsole: true,
  cinderella: {build: 1901, version: [2, 9, 1901]}
});
var setm=function(m){
  cdy.evokeCS('setmode("'+m+'");');

}
    </script>

</head>
<body>

<div class="mode-selector">
        <input id="move" type="radio" name="mode-type" value="move" checked=true onclick="setm('move')"/>
        <label class="mode move" for="move" style="background-image:url('images/move.png');"></label>
        <input id="addpt" type="radio" name="mode-type" value="addpt"  onclick="setm('singlepoint')"/>
        <label class="mode addpt" for="addpt" style="background-image:url('images/single-add.png');"></label>
        <input id="addmid" type="radio" name="mode-type" value="addmid"  onclick="setm('middle')"/>
        <label class="mode addmid" for="addmid" style="background-image:url('images/multi-add-middle.png');"></label>
        <input id="addln" type="radio" name="mode-type" value="addln"  onclick="setm('singleline')"/>
        <label class="mode addln" for="addln" style="background-image:url('images/multi-add-line.png');"></label>
        <input id="addcirclepp" type="radio" name="mode-type" value="addcirclepp"  onclick="setm('circlepp')"/>
        <label class="mode addcirclepp" for="addcirclepp" style="background-image:url('images/multi-add-circle.png');"></label>
        <input id="addcirclepr" type="radio" name="mode-type" value="addcirclepr"  onclick="setm('circlepr')"/>
        <label class="mode addcirclepr" for="addcirclepr" style="background-image:url('images/circle-by-radius.png');"></label>

</div>


    <div id="CSCanvas"></div>
</body>
</html>
